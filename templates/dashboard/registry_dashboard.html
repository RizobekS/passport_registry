{% extends layout_path %}
{% load static %}
{% block title %}Панель аналитики{% endblock title %}

{% block vendor_js %}{{ block.super }}
<script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
{% endblock %}

{% block page_js %}{{ block.super }}
<script>
  window.REG_DATA = {
    kpi: {{ kpi|safe }},
    status: {{ by_status|safe }},
    region: {{ by_region|safe }},
    breed: {{ by_breed|safe }},
    daily: {{ by_day|safe }},
    owner_kind: {{ by_owner_kind|safe }},
    horse_type: {{ by_horse_type|safe }},
    monthly: {{ by_month|safe }},
    owners: {{ owners|safe }}
  };
</script>
<script src="{% static 'js/registry_dashboard.js' %}"></script>
{% endblock %}

{% block content %}
<div class="row g-4">

  <div class="col-xxl-8">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">Сводка</h5>
        <div class="row g-3">
          <div class="col-sm-4">
            <div class="card shadow-none border">
              <div class="card-body">
                <p class="mb-1">Всего паспортов</p>
                <h3 class="mb-0" id="kpi-total">—</h3>
              </div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="card shadow-none border">
              <div class="card-body">
                <p class="mb-1">Выдано</p>
                <h3 class="mb-0" id="kpi-issued">—</h3>
              </div>
            </div>
          </div>
          <div class="col-sm-4">
            <div class="card shadow-none border">
              <div class="card-body">
                <p class="mb-1">Аннулировано</p>
                <h3 class="mb-0" id="kpi-revoked">—</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xxl-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">Статусы</h5>
        <div id="chartStatus"></div>
      </div>
    </div>
  </div>

  {# НОВОЕ: срез по типу владельца (пирог) #}
  <div class="col-xxl-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">Тип владельца</h5>
        <div id="chartOwnerKind"></div>
      </div>
    </div>
  </div>

  <div class="col-xxl-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
          <h5 class="mb-0">Владельцы (кол-во паспортов)</h5>
          <div class="d-flex align-items-center gap-2">
            <select id="ownerKindFilter" class="form-select form-select-sm" style="width:auto;">
              <option value="ALL">Все</option>
              <option value="PERSON">Физические лица</option>
              <option value="STATE">Юр. лица (гос)</option>
              <option value="PRIVATE">Юр. лица (частные)</option>
            </select>
            <input type="search" id="ownerSearch" class="form-control form-control-sm"
                   placeholder="Фильтр по названию/ФИО..." style="width:260px;">
          </div>
        </div>
        <div id="chartOwners"></div>
        <div class="text-muted small mt-2">Показываются топ-20 по текущему фильтру.</div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">ТОП регионов</h5>
        <div id="chartRegion"></div>
      </div>
    </div>
  </div>

  <div class="col-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">Выдачи по дням (30 дней)</h5>
        <div id="chartDaily"></div>
      </div>
    </div>
  </div>

  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">Доля пород</h5>
        <div id="chartBreed"></div>
      </div>
    </div>
  </div>
  {# НОВОЕ: распределение по типам лошадей #}
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">Типы лошадей</h5>
        <div id="chartHorseType"></div>
      </div>
    </div>
  </div>

  {# НОВОЕ: выдачи по месяцам (12 мес) #}
  <div class="col-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="mb-4">Выдачи по месяцам (12&nbsp;мес.)</h5>
        <div id="chartMonthly"></div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
