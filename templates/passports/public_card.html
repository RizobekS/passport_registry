{% extends 'layout/master.html' %}
{% load static %}
{% load pdf_utils %}
<style>
  /* Размер страницы и поля */
  @page {
    size: A4;
    margin: 12mm 12mm 16mm 12mm;
    @bottom-center {
      content: "Стр. " counter(page) " из " counter(pages);
      font-size: 9pt;
      color: #444;
      border-top: 0.5pt solid #999;
      padding-top: 3mm;
    }
  }

  /* Шрифты: DejaVu Sans покрывает кириллицу и узбекский (латиница) */
  body {
    font-family: "DejaVu Sans", Arial, sans-serif;
    color: #111;
    line-height: 1.3;
    font-size: 10.5pt;
    word-break: break-word;
  }

  /* ФОН ЧЕРЕЗ IMG */
  .bg-img {
    position:absolute; left:0; top:0;
    width: 210mm; height: 297mm;
    object-fit: cover;
    z-index: 0;
  }

  h1, h2, h3 { margin: 0 0 6mm 0; text-align: center; }
  .muted { color:#555; }

  /* Таблица-паспорт (устойчивая верстка) */
  .table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;     /* чтобы ничего не «ехало» */
  }
  .table th, .table td {
    border: 0.6pt solid #333;
    vertical-align: top;
    padding: 2.5mm;
  }
  .table .w-label { width: 48mm; }
  .table td { white-space: pre-wrap; } /* многоязычные подписи */
  .kv { margin-top: 1.5mm; font-size: 9pt; color:#444 }

  /* Грид для блока кодов */
  .row { display: flex; gap: 8mm; align-items: flex-start; margin: 4mm 0 6mm 0; }
  .col { flex: 1; }
  .qr    { width: 36mm; height: auto; display:block; }
  .barcode { width: 70mm; height: auto; display:block; }

  /* Разделитель между логическими секциями */
  .section { margin: 6mm 0; }
  .page-break { page-break-before: always; }

  /* Мелкие хелперы */
  .center { text-align:center; }

  .title{ text-align:center; margin:0 0 2mm 0; }
  .tri{ display:block; text-align:center; }

  .parentage { margin-top:10mm; }
  .pgrid { width:100%; border-collapse:collapse; table-layout:fixed; }
  .pgrid td { border-bottom:0.6pt solid #333; padding:1.6mm 0; vertical-align:bottom; font-size:10.5pt; }
  .lab { width:28%; color:#333; }
  .val { width:72%; padding-left:2mm; }
  .thin { border-bottom:0.4pt solid #999; }

  .sport-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-top:3mm; }
  .sport-table th,.sport-table td{ border:0.6pt solid #333; vertical-align:top; padding:2mm; line-height:1.25; font-size:10.5pt; }

  .row-fill{ height:14mm; }
  .lined{
    min-height:12mm;
    background-image:linear-gradient(to bottom, transparent 92%, #bbb 92%, #bbb 94%, transparent 94%);
    background-size:100% 6mm;
    padding:1mm 1.25mm;
  }

  .exh-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-top:3mm; }
  .exh-table th,.exh-table td{ border:0.6pt solid #333; vertical-align:top; padding:2mm; line-height:1.25; font-size:10.5pt; }
  .c-year{ width:14%; } .c-place{ width:36%; } .c-info{ width:50%; }

  .offs-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-top:3mm; }
  .offs-table th,.offs-table td{ border:0.6pt solid #333; vertical-align:top; padding:2mm; line-height:1.25; font-size:10.5pt; }

  /* ширины колонок, близкие к бланку */
  .c-no{ width:7%; }
  .c-par-name{ width:23%; }
  .c-par-breed{ width:20%; }
  .c-colour{ width:12%; }
  .c-sex{ width:10%; }
  .c-brand{ width:13%; }
  .c-birth{ width:15%; }

  .small{ font-size:9pt; }

  .chip-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-top:3mm; }
  .chip-table th,.chip-table td{ border:0.6pt solid #333; vertical-align:top; padding:2mm; line-height:1.25; font-size:10.5pt; }
  .c-date{ width:18%; } .c-chip{ width:32%; } .c-bar{ width:50%; }

  .barcode { height:14mm; max-width:100%; display:block; }
  .row-fill{ height:16mm; }
  .lined{
    min-height:14mm;
    background-image:linear-gradient(to bottom, transparent 92%, #bbb 92%, #bbb 94%, transparent 94%);
    background-size:100% 7mm; padding:1mm 1.25mm;
  }

  .signbox { margin-top:8mm; font-size:10.5pt; }
  .line { border-bottom:0.6pt solid #333; display:inline-block; width:85%; vertical-align:bottom; }
</style>
{% block extra_css %}{% endblock %}
{% block layout %}
<!--<div class="container-xxl flex-grow-1 container-p-y">-->
<!--  <div class="d-flex align-items-center justify-content-between mb-4">-->
<!--    <h4 class="mb-0">Паспорт № {{ p.number }}</h4>-->
<!--    <div>-->
<!--      {% if p.pdf_file %}-->
<!--      <a class="btn btn-outline-secondary" href="{{ p.pdf_file.url }}" target="_blank">PDF</a>-->
<!--      {% endif %}-->
<!--    </div>-->
<!--  </div>-->
<!--  <div class="row g-4">-->
<!--    <div class="col-lg-8">-->
<!--      <div class="card h-100">-->
<!--        <div class="card-body">-->
<!--          <h6 class="text-muted">Данные лошади</h6>-->
<!--          <hr>-->
<!--          <div class="row mb-10">-->
<!--            <div class="col-sm-6"><strong>Кличка:</strong> {{ p.horse.name }}</div>-->
<!--            <div class="col-sm-6"><strong>Микрочип:</strong> {{ p.horse.microchip }}</div>-->
<!--            <div class="col-sm-6"><strong>Порода:</strong> {{ p.horse.breed.name }}</div>-->
<!--            <div class="col-sm-6"><strong>Масть:</strong> {{ p.horse.color.name }}</div>-->
<!--            <div class="col-sm-6"><strong>Дата рождения:</strong> {{ p.horse.birth_date|date:'d.m.Y' }}</div>-->
<!--            <div class="col-sm-6"><strong>Регион рождения:</strong> {{ p.horse.place_of_birth.name }}</div>-->
<!--            <div class="col-sm-6"><strong>Отец:</strong> {{ p.horse.sire|default:'—' }}</div>-->
<!--            <div class="col-sm-6"><strong>Мать:</strong> {{ p.horse.dam|default:'—' }}</div>-->
<!--          </div>-->

<!--          <h6 class="text-muted">Ветеринарные отметки</h6>-->
<!--          <div class="mb-10 table-responsive">-->
<!--            <table class="table table-sm">-->
<!--              <thead>-->
<!--              <tr>-->
<!--                <th>Дата</th>-->
<!--                <th>Тип</th>-->
<!--                <th>Название/результат</th>-->
<!--                <th>Врач</th>-->
<!--              </tr>-->
<!--              </thead>-->
<!--              <tbody>-->
<!--              {% for v in p.horse.vaccinations.all %}-->
<!--              <tr>-->
<!--                <td>{{ v.date|date:'d.m.Y' }}</td>-->
<!--                <td>Вакцинация</td>-->
<!--                <td>{{ v.vaccine.name }}{% if v.batch_no %} ({{ v.batch_no }}){% endif %}</td>-->
<!--                <td>{{ v.veterinarian }}</td>-->
<!--              </tr>-->
<!--              {% empty %}-->
<!--              <tr>-->
<!--                <td colspan="4" class="text-center">Нет данных</td>-->
<!--              </tr>-->
<!--              {% endfor %}-->
<!--              {% for t in p.horse.lab_tests.all %}-->
<!--              <tr>-->
<!--                <td>{{ t.date|date:'d.m.Y' }}</td>-->
<!--                <td>{{ t.test_type.name }}</td>-->
<!--                <td>{{ t.result }}</td>-->
<!--                <td>{{ t.veterinarian }}</td>-->
<!--              </tr>-->
<!--              {% endfor %}-->
<!--              </tbody>-->
<!--            </table>-->
<!--          </div>-->
<!--          <div class="card-footer text-center">-->
<!--            {% if p.barcode_image %}<img src="{{ p.barcode_image.url }}" class="mb-3" style="max-width:260px;" alt="BAR"/>{% endif %}-->
<!--            <div class="text-muted">Статус: {{ p.get_status_display }}{% if p.issue_date %} от {{ p.issue_date|date:'d.m.Y' }}{% endif %}-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

  <div class="cover">
    <img src="{{ public_base_url }}{% static 'report/passport_1.png' %}">
  </div>

<h3 class="muted">Настоящий документ сохраняется владельцем (смотрителем) лошади и передается новому владельцу при продаже лошади.</h3>

  <div class="row">
    <div class="col">
      {% if p.barcode_image %}<img class="barcode" src="{{ p.barcode_image|fileuri }}" alt="barcode">{% endif %}
      <div class="kv">Штрих-код</div>
    </div>
    <div style="width:42mm">
      {% if p.qr_image %}<img class="qr" src="{{ p.qr_image|fileuri }}" alt="qr">{% endif %}
      <div class="kv">QR-код</div>
    </div>
  </div>

  <table class="table">
    <colgroup><col class="w-label"><col></colgroup>
    <tbody>
      <tr><th>Кличка / Name:</th>
          <td>{{ horse.name|dash }}</td></tr>

      <tr><th>Дата рождения / Date of birth:</th>
          <td>{{ horse.birth_date|dmy|dash }}</td></tr>

      <tr><th>Порода / Breed:</th>
          <td>{{ horse.breed|dash }}</td></tr>

      <tr><th>Масть / Colour:</th>
          <td>{{ horse.color|dash }}</td></tr>

      <tr><th>Пол / Sex:</th>
          <td>{{ horse.get_sex_display|dash }}</td></tr>

      <tr><th>Место рождения / Place of birth:</th>
          <td>{{ horse.place_of_birth|dash }}</td></tr>

      <tr><th>Номер паспорта / Passport Number:</th>
          <td>{{ passport.number|dash }}</td></tr>

      <tr><th>Владелец / Owner:</th>
          <td>
            {% if horse.owner_current %}
              {% with o=horse.owner_current %}
                {% if o.person %}{{ o.person.last_name }} {{ o.person.first_name }} {{ o.person.middle_name }}{% endif %}
                {% if o.organization %}{{ o.organization.name }}{% endif %}
                {% if o.address %}, {{ o.address }}{% endif %}
              {% endwith %}
            {% else %}—{% endif %}
          </td></tr>

      <tr><th>Страна / Country:</th>
          <td>Узбекистан</td></tr>

      <tr><th>Номер микрочипа / Microchip number:</th>
          <td>{{ horse.microchip|dash }}</td></tr>
    </tbody>
  </table>

  <h3>График тасвири<br>Графическое изображение <br> Graphical photos<br><span class="muted">(реальные фотографии лошади)</span></h3>

  <!-- Ряд 1: правая сторона — верхний уровень глаз — левая сторона -->
  <div class="grid">
    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_right_side %}
          <img src="{{ horse.photo_right_side|fileuri }}" alt="Right side">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Ўнг ён томонидан кўриниш<br>
        Правая боковая сторона<br>
        <strong>Right side</strong>
      </figcaption>
    </figure>

    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_upper_eye_level %}
          <img src="{{ horse.photo_upper_eye_level|fileuri }}" alt="Upper eye level">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Кўзнинг юқори қисми<br>
        Верхний уровень глаза<br>
        <strong>Upper eye level</strong>
      </figcaption>
    </figure>

    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_left_side %}
          <img src="{{ horse.photo_left_side|fileuri }}" alt="Left side">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Чап ён томонидан кўриниш<br>
        Левая боковая сторона<br>
        <strong>Left side</strong>
      </figcaption>
    </figure>
  </div>

  <!-- Ряд 2: передние ноги спереди — морда крупно — задние ноги спереди -->
  <div class="grid" style="margin-top: 4mm;">
    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_front_view_forelegs %}
          <img src="{{ horse.photo_front_view_forelegs|fileuri }}" alt="Forelegs front view">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Олд оёқ (олдиндан)<br>
        Передние ноги (вид спереди)<br>
        <strong>Forelegs, front view</strong>
      </figcaption>
    </figure>

    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_muzzle %}
          <img src="{{ horse.photo_muzzle|fileuri }}" alt="Muzzle">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Тумшуқ<br>
        Морда (крупно)<br>
        <strong>Muzzle</strong>
      </figcaption>
    </figure>

    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_front_view_hind_legs %}
          <img src="{{ horse.photo_front_view_hind_legs|fileuri }}" alt="Hind legs front view">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Орқа оёқ (олдиндан)<br>
        Задние ноги (вид спереди)<br>
        <strong>Hind legs, front view</strong>
      </figcaption>
    </figure>
  </div>

  <!-- Ряд 3: передние ноги сзади — шея снизу — задние ноги сзади -->
  <div class="grid" style="margin-top: 4mm;">
    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_hind_view_forelegs %}
          <img src="{{ horse.photo_hind_view_forelegs|fileuri }}" alt="Forelegs hind view">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Олд оёқ (орқадан)<br>
        Передние ноги (вид сзади)<br>
        <strong>Forelegs, hind view</strong>
      </figcaption>
    </figure>

    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_neck_lower_view %}
          <img src="{{ horse.photo_neck_lower_view|fileuri }}" alt="Neck lower view">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Бўйин (паст томондан)<br>
        Шея (снизу)<br>
        <strong>Neck lower view</strong>
      </figcaption>
    </figure>

    <figure class="photo">
      <div class="imgwrap">
        {% if horse.photo_hind_view_hind_legs %}
          <img src="{{ horse.photo_hind_view_hind_legs|fileuri }}" alt="Hind legs hind view">
        {% else %}
          <div class="placeholder">Нет фото</div>
        {% endif %}
      </div>
      <figcaption>
        Орқа оёқ (орқадан)<br>
        Задние ноги (вид сзади)<br>
        <strong>Hind legs, hind view</strong>
      </figcaption>
    </figure>
  </div>

<h3 class="hdr">Белгиларнинг ёзма ифодаланиши <br> Описание примет <br> Description of signs</h3>

<table class="signs-table">
    <colgroup><col class="w-label"><col></colgroup>
    <tbody>
      <!-- Голова -->
      <tr class="row-lg">
        <th>
          <span class="tri">Боши</span>
          <span class="tri">Голова</span>
          <span class="tri"><strong>Head</strong></span>
        </th>
        {# <td>{{ marks.head|default:horse.ident_notes|dash }}</td> #}
      </tr>

      <!-- Левая передняя нога -->
      <tr class="row-sm">
        <th>
          <span class="tri">Чап олд оёғи</span>
          <span class="tri">Левая передняя нога</span>
          <span class="tri"><strong>Left Foreleg</strong></span>
        </th>
        <td>{{ marks.left_foreleg|dash }}</td>
      </tr>

      <!-- Правая передняя нога -->
      <tr class="row-sm">
        <th>
          <span class="tri">Ўнг олд оёғи</span>
          <span class="tri">Правая передняя нога</span>
          <span class="tri"><strong>Right Foreleg</strong></span>
        </th>
        <td>{{ marks.right_foreleg|dash }}</td>
      </tr>

      <!-- Левая задняя нога -->
      <tr class="row-sm">
        <th>
          <span class="tri">Чап орқа оёғи</span>
          <span class="tri">Левая задняя нога</span>
          <span class="tri"><strong>Left Hindleg</strong></span>
        </th>
        <td>{{ marks.left_hindleg|dash }}</td>
      </tr>

      <!-- Правая задняя нога -->
      <tr class="row-sm">
        <th>
          <span class="tri">Ўнг орқа оёғи</span>
          <span class="tri">Правая задняя нога</span>
          <span class="tri"><strong>Right Hindleg</strong></span>
        </th>
        <td>{{ marks.right_hindleg|dash }}</td>
      </tr>

      <!-- Дополнительные приметы -->
      <tr class="row-xl">
        <th>
          <span class="tri">Қўшимча белгилар</span>
          <span class="tri">Дополнительные приметы</span>
          <span class="tri"><strong>Extra signs</strong></span>
        </th>
        <td>{{ marks.extra|dash }}</td>
      </tr>
    </tbody>
  </table>

<h3 class="hdr">
    <!-- Заголовок можно убрать, если не требуется -->
    <span class="muted">Владелец и адрес / Owner & stable</span>
  </h3>

  <table class="owner-stable">
    <colgroup>
      <col class="col-50">
      <col class="col-50">
    </colgroup>

    <!-- Шапка -->
    <thead>
      <tr>
        <th>
          От эгасининг ф.и.ш. ва манзили<br>
          Ф.И.О владельца и адрес<br>
          <strong>Name, address of the owner</strong>
        </th>
        <th>
          Отхонa манзили<br>
          Адрес конюшни<br>
          <strong>Address of the stable</strong>
        </th>
      </tr>
    </thead>

    <tbody>
      <!-- Первая строка — пытаемся заполнить из БД -->
      <tr class="row-fill">
        <td class="lined">
          {% if horse.owner_current %}
            {% with o=horse.owner_current %}
              {% if o.person %}
                {{ o.person.last_name }} {{ o.person.first_name }} {{ o.person.middle_name }}{% if o.address %}, {{ o.address }}{% endif %}
              {% elif o.organization %}
                {{ o.organization.name }}{% if o.address %}, {{ o.address }}{% endif %}
              {% else %}
                <!-- нет детальных данных -->
              {% endif %}
            {% endwith %}
          {% endif %}
        </td>
        <td class="lined">
          {# если адрес стойла хранится у владельца или в самом Horse — выведем #}
          {% if horse.owner_current and horse.owner_current.address %}
            {{ horse.owner_current.address }}
          {% elif horse.place_of_birth %}
            {{ horse.place_of_birth }}
          {% endif %}
        </td>
      </tr>

      <!-- Пустые строки для ручного заполнения -->
      <tr class="row-fill">
        <td class="lined"></td>
        <td class="lined"></td>
      </tr>
      <tr class="row-fill">
        <td class="lined"></td>
        <td class="lined"></td>
      </tr>
      <tr class="row-fill">
        <td class="lined"></td>
        <td class="lined"></td>
      </tr>
    </tbody>
  </table>

  <div class="sheet">
    <img src="{{ public_base_url }}{% static 'report/passport_7.png' %}" alt="">
  </div>

  <h3 class="title">
    Отларни эмлаш (вакцинация килин) тўғрисида белгилар<br>
    Отметки о вакцинации лошадей<br>
    <span class="muted">Vaccination record</span>
  </h3>

  <table class="vacc-table">
    <colgroup>
      <col class="col-vaccine">
      <col class="col-manuf">
      <col class="col-vaccdate">
      <col class="col-vet">
    </colgroup>

    <thead>
      <tr>
        <th>
          <span class="tri">Эмаланишнинг номи</span>
          <span class="tri">Наименование вакцины</span>
          <span class="tri"><strong>Name of vaccine</strong></span>
        </th>
        <th>
          <span class="tri">Эмаланиш тайёрланган санаси, серия рақами, тайёрловчининг манзили</span>
          <span class="tri">Дата изготовления вакцины, номер серии, страна изготовитель</span>
          <span class="tri"><strong>Date of manufacture, batch number, place and country manufacturer</strong></span>
        </th>
        <th>
          <span class="tri">Эмаланган санаси, эмламанинг қайд этилган рақами</span>
          <span class="tri">Дата вакцинации, номер регистрации вакцины</span>
          <span class="tri"><strong>Date of vaccination, registration number</strong></span>
        </th>
        <th>
          <span class="tri">Ветеринария врачининг ф.и.ш., имзоси, муҳри</span>
          <span class="tri">Ф.И.О. ветеринарного врача, подпись, печать</span>
          <span class="tri"><strong>Name, signature and stamp of official veterinarian</strong></span>
        </th>
      </tr>
    </thead>

    <tbody>
      {# реальные записи из БД #}
      {% for v in horse.vaccinations.all|dictsort:"date" %}
        <tr>
          <td>
            {% if v.vaccine %}{{ v.vaccine.name }}{% endif %}
          </td>
          <td>
            {# что у нас реально есть в моделях: batch_no и vaccine.manufacturer #}
            {% if v.vaccine and v.vaccine.manufacturer %}{{ v.vaccine.manufacturer }}{% endif %}
            {% if v.batch_no %}{% if v.vaccine and v.vaccine.manufacturer %}, {% endif %}серия: {{ v.batch_no }}{% endif %}
            {% if v.place %}{% if v.vaccine or v.batch_no %}, {% endif %}{{ v.place }}{% endif %}
          </td>
          <td>
            {{ v.date|dmy }}
            {% if v.batch_no %} — № регистрации: {{ v.batch_no }}{% endif %}
          </td>
          <td>
            {% if v.veterinarian %}
              {% with p=v.veterinarian.person %}
                {% if p %}{{ p.last_name }} {{ p.first_name }} {{ p.middle_name }}{% endif %}
              {% endwith %}
              {% if v.veterinarian.license_no %}<br>Лицензия: {{ v.veterinarian.license_no }}{% endif %}
            {% endif %}
          </td>
        </tr>
      {% endfor %}

      {# 3 пустые строки для ручного заполнения #}
      <tr class="row-fill">
        <td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td>
      </tr>
      <tr class="row-fill">
        <td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td>
      </tr>
      <tr class="row-fill">
        <td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td>
      </tr>
    </tbody>
  </table>

 <h3 class="title">
    Лаборатор текширувлар (диагностика) қайдлари<br>
    Записи о лабораторных/диагностических исследованиях<br>
    <span class="muted">Laboratory / diagnostic tests record</span>
  </h3>

  <table class="labs-table">
    <colgroup>
      <col class="c-test">
      <col class="c-date">
      <col class="c-result">
      <col class="c-vet">
    </colgroup>

    <thead>
      <tr>
        <th>
          <span class="tri">Тест номи</span>
          <span class="tri">Наименование теста</span>
          <span class="tri"><strong>Name of test</strong></span>
        </th>
        <th>
          <span class="tri">Текширув санаси, ҳужжат №</span>
          <span class="tri">Дата исследования, № документа</span>
          <span class="tri"><strong>Date of test, document No.</strong></span>
        </th>
        <th>
          <span class="tri">Текширув натижаси</span>
          <span class="tri">Результат исследования</span>
          <span class="tri"><strong>Result of the test</strong></span>
        </th>
        <th>
          <span class="tri">Ветеринар Ф.И.Ш., имзо, муҳр</span>
          <span class="tri">Ф.И.О. ветврача, подпись, печать</span>
          <span class="tri"><strong>Name, signature and stamp of official veterinarian</strong></span>
        </th>
      </tr>
    </thead>

    <tbody>
      {# реальные записи из БД #}
      {% for t in horse.lab_tests.all|dictsort:"date" %}
        <tr>
          <td>{% if t.test_type %}{{ t.test_type.name }}{% else %}—{% endif %}</td>
          <td>
            {{ t.date|dmy|dash }}
            {% if t.document and t.document.name %}<br>№: {{ t.document.name|slice:"-32:" }}{% endif %}
            {# при желании сюда можно вынести номер/рег. из отдельного поля #}
          </td>
          <td>{{ t.result|dash }}</td>
          <td>
            {% if t.veterinarian %}
              {% with p=t.veterinarian.person %}
                {% if p %}{{ p.last_name }} {{ p.first_name }} {{ p.middle_name }}{% endif %}
              {% endwith %}
              {% if t.veterinarian.license_no %}<br>Лицензия: {{ t.veterinarian.license_no }}{% endif %}
            {% else %}—{% endif %}
          </td>
        </tr>
      {% endfor %}

      {# несколько пустых строк для рукописного внесения #}
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
    </tbody>
  </table>

  <h3 class="title">
    Лаборатория текширишлари ўтказилганлиги тўғрисида маълумот<br>
    Данные о проведении лабораторных исследований<br>
    <span class="muted">Laboratory health test</span>
  </h3>

  <table class="labs10">
    <colgroup>
      <col class="c-date">
      <col class="c-type">
      <col class="c-dis">
      <col class="c-res">
      <col class="c-lab">
    </colgroup>

    <thead>
      <tr>
        <th>
          <span class="tri">Сана</span>
          <span class="tri">Дата</span>
          <span class="tri"><strong>Date</strong></span>
        </th>
        <th>
          <span class="tri">Текшириш тури</span>
          <span class="tri">Вид исследования</span>
          <span class="tri"><strong>Type of test</strong></span>
        </th>
        <th>
          <span class="tri">Касаллик номи</span>
          <span class="tri">Название болезни</span>
          <span class="tri"><strong>Name of disease</strong></span>
        </th>
        <th>
          <span class="tri">Текшириш натижалари</span>
          <span class="tri">Результат исследования</span>
          <span class="tri"><strong>Result of the tests</strong></span>
        </th>
        <th>
          <span class="tri">Лабораториянинг номи, манзили ва муҳр</span>
          <span class="tri">Наименование, адрес лаборатории и печать</span>
          <span class="tri"><strong>Name and Address of the laboratory and Company Stamp</strong></span>
        </th>
      </tr>
    </thead>

    <tbody>
      {# реальные записи из БД; если каких-то полей нет — оставляем пусто #}
      {% for t in horse.lab_tests.all|dictsort:"date" %}
        <tr>
          <td>{{ t.date|dmy|dash }}</td>
          <td>{% if t.test_type %}{{ t.test_type.name }}{% else %}—{% endif %}</td>
          <td>
            {# у нас нет отдельного поля «болезнь» — оставляем пустым либо дублируем часть результата при желании #}
          </td>
          <td>{{ t.result|dash }}</td>
          <td>
            {# если лаборатория хранится через ветеринара — выведем его ФИО/лицензию; адреса как такового нет в модели #}
            {% if t.veterinarian %}
              {% with p=t.veterinarian.person %}
                {% if p %}{{ p.last_name }} {{ p.first_name }} {{ p.middle_name }}{% endif %}
              {% endwith %}
              {% if t.veterinarian.license_no %}<br>Лицензия: {{ t.veterinarian.license_no }}{% endif %}
            {% endif %}
          </td>
        </tr>
      {% endfor %}

      {# 4 пустые строки для ручного внесения #}
      <tr class="row-fill">
        <td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td>
      </tr>
      <tr class="row-fill">
        <td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td>
      </tr>
      <tr class="row-fill">
        <td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td>
      </tr>
      <tr class="row-fill">
        <td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td>
      </tr>
    </tbody>
  </table>

 <h3>Диагностик текширишлар ўтказилганлиги тўғрисида маълумотлар <br> Данные о проведении диагностических исследований<br><span>Data on diagnostic medication control</span></h3>

  <table class="table">
    <colgroup>
      <col style="width: 45%">
      <col style="width: 20%">
      <col style="width: 35%">
    </colgroup>
    <thead>
      <tr>
        <th>Результат исследования<br><span class="muted">Result of the tests</span></th>
        <th>Номер экспертизы<br><span class="muted">Number of expertise</span></th>
        <th>Ф.И.О., подпись и печать ветеринарного врача<br><span class="muted">Name, signature and stamp of official veterinarian</span></th>
      </tr>
    </thead>
    <tbody>
      {% for d in horse.diagnostics.all|dictsortreversed:"date" %}
        <tr>
          <td>{{ d.date|dmy }} — {{ d.result|dash }}</td>
          <td>{{ d.expertise_no|dash }}</td>
          <td>{{ d.veterinarian.person.last_name }} {{ d.veterinarian.person.first_name }}<br>Лицензия: {{ d.veterinarian.license_no|dash }}</td>
        </tr>
      {% endfor %}
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>

    </tbody>
  </table>

  <h3 class="title">
    Синовлар ва спорт ютуқлари тўғрисида маълумотлар<br>
    Сведения об испытаниях и спортивных достижениях<br>
    <span class="muted">Information of the tests and sport achievements</span>
  </h3>

  <table class="sport-table">
    <colgroup><col class="c-year"><col class="c-place"><col class="c-info"></colgroup>
    <thead>
      <tr>
        <th><span class="tri">Йил</span><span class="tri">Год</span><span class="tri"><strong>Year</strong></span></th>
        <th><span class="tri">Жойи</span><span class="tri">Место</span><span class="tri"><strong>Place</strong></span></th>
        <th><span class="tri">Малумотлар</span><span class="tri">Сведения</span><span class="tri"><strong>Info</strong></span></th>
      </tr>
    </thead>
    <tbody>
      {% for a in horse.achievements.all|dictsortreversed:"year" %}
        <tr>
          <td>{{ a.year|dash }}</td>
          <td>{{ a.place|dash }}</td>
          <td>{{ a.info|dash }}</td>
        </tr>
      {% endfor %}

      {# Пустые строки для ручного заполнения #}
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
    </tbody>
  </table>

  <h3 class="title">
    Кўргазмалардаги чиқишлари тўғрисида маълумотлар<br>
    Сведения о выставках-выводках<br>
    <span class="muted">Information of exhibitions and demonstrations</span>
  </h3>

  <table class="exh-table">
    <colgroup><col class="c-year"><col class="c-place"><col class="c-info"></colgroup>
    <thead>
      <tr>
        <th><span class="tri">Йил</span><span class="tri">Год</span><span class="tri"><strong>Year</strong></span></th>
        <th><span class="tri">Жойи</span><span class="tri">Место</span><span class="tri"><strong>Place</strong></span></th>
        <th><span class="tri">Малумотлар</span><span class="tri">Сведения</span><span class="tri"><strong>Info</strong></span></th>
      </tr>
    </thead>
    <tbody>
      {% for e in horse.exhibitions.all|dictsortreversed:"year" %}
        <tr>
          <td>{{ e.year|dash }}</td>
          <td>{{ e.place|dash }}</td>
          <td>{{ e.info|dash }}</td>
        </tr>
      {% endfor %}

      {# Пустые строки для ручного заполнения #}
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
    </tbody>
  </table>

  <h3 class="title">
    Қулун олиш<br>Приплод<br><span class="muted">Offspring</span>
  </h3>

  <table class="offs-table">
    <colgroup>
      <col class="c-no"><col class="c-par-name"><col class="c-par-breed">
      <col class="c-colour"><col class="c-sex"><col class="c-brand"><col class="c-birth">
    </colgroup>

    <thead>
      <tr>
        <th rowspan="2">№/P</th>

        <th>
          <span class="tri">Ота-онасининг лакаби</span>
          <span class="tri">Кличка родителей</span>
          <span class="tri"><strong>Parental name</strong></span>
        </th>
        <th>
          <span class="tri">Ота-онасининг зоти</span>
          <span class="tri">Порода родителей</span>
          <span class="tri"><strong>Parental breed</strong></span>
        </th>

        <th rowspan="2">
          <span class="tri">Туси</span>
          <span class="tri">Масть</span>
          <span class="tri"><strong>Colour</strong></span>
        </th>
        <th rowspan="2">
          <span class="tri">Жинси</span>
          <span class="tri">Пол</span>
          <span class="tri"><strong>Sex</strong></span>
        </th>
        <th rowspan="2">
          <span class="tri">Тамга рақами</span>
          <span class="tri">Тавро №</span>
          <span class="tri"><strong>Brand №</strong></span>
        </th>
        <th rowspan="2">
          <span class="tri">Туғилган йили</span>
          <span class="tri">Год рождения</span>
          <span class="tri"><strong>Date of birth</strong></span>
        </th>
      </tr>
      <tr class="small">
        <th><span class="tri">Отаси / Онаси — Отец / Мать — Sire / Dam</span></th>
        <th><span class="tri">Отаси / Онаси — Отец / Мать — Sire / Dam</span></th>
      </tr>
    </thead>

    <tbody>
      {% for i,o in horse.offspring.all|dictsort:"birth_year" %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>Отец: {{ o.sire_name|dash }}<br>Мать: {{ o.dam_name|dash }}</td>
          <td>Отец: {{ o.sire_breed|dash }}<br>Мать: {{ o.dam_breed|dash }}</td>
          <td>{{ o.colour|dash }}</td>
          <td>{{ o.sex|dash }}</td>
          <td>{{ o.brand_no|dash }}</td>
          <td>{% if o.birth_year %}{{ o.birth_year }}{% else %}—{% endif %}</td>
        </tr>
      {% endfor %}

      {# Пустые строки #}
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
    </tbody>
  </table>

  <h3 class="title">
    От эгасининг ўзгарганлиги тўғрисида маълумот<br>
    Сведения о смене владельца<br>
    <span class="muted">Information on change of the ownership</span>
  </h3>

  <table class="ownchg">
    <colgroup><col class="c-date"><col class="c-owner"><col class="c-sign"></colgroup>
    <thead>
      <tr>
        <th>
          <span class="tri">Сотилган санаси</span>
          <span class="tri">Дата продажи</span>
          <span class="tri"><strong>Date of sale</strong></span>
        </th>
        <th>
          <span class="tri">От эгасининг Ф.И.Ш. ва манзили</span>
          <span class="tri">Ф.И.О., владельца и адрес</span>
          <span class="tri"><strong>Name, address of the owner</strong></span>
        </th>
        <th>
          <span class="tri">Ўзбекистон ёки/ичкингина ва от спорти федерацияси ваколатли</span>
          <span class="tri">Подпись и место печати</span>
          <span class="tri"><strong>Signature and Company Stamp</strong></span>
        </th>
      </tr>
    </thead>
    <tbody>
      {# текущий владелец как последняя запись владения (если есть) #}
      {% with cur=horse.owner_current %}
      <tr class="row-fill">
        <td class="lined">
          {% with last=horse.ownerships.all|first %}{% if last %}{{ last.start_date|dmy }}{% endif %}{% endwith %}
        </td>
        <td class="lined">
          {% if cur %}
            {% if cur.person %}
              {{ cur.person.last_name }} {{ cur.person.first_name }} {{ cur.person.middle_name }}{% if cur.person.address %}, {{ cur.person.address }}{% endif %}
            {% elif cur.organization %}
              {{ cur.organization.name }}{% if cur.organization.address %}, {{ cur.organization.address }}{% endif %}
            {% endif %}
          {% endif %}
        </td>
        <td class="lined"></td>
      </tr>
      {% endwith %}

      {# +3 пустых строки для ручной записи будущих смен владельца #}
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
    </tbody>
  </table>

  <!-- Блок Parentage (текстовый), как на макете под таблицей -->
  <div class="parentage">
    <div class="two-col">
      <table class="pgrid">
        <tbody>
          <tr><td class="lab">Туғилган жойи / Place of birth</td><td class="val thin">{{ horse.place_of_birth|dash }}</td></tr>
          <tr><td class="lab">Кличка / Name</td><td class="val thin">{{ horse.name|dash }}</td></tr>
          <tr><td class="lab">Тавро / Brand</td><td class="val thin">{{ horse.brand_mark|dash }}</td></tr>
          <tr><td class="lab">Зоти / Breed</td><td class="val thin">{{ horse.breed|dash }}</td></tr>
          <tr><td class="lab">Жинси / Sex</td><td class="val thin">{{ horse.get_sex_display|dash }}</td></tr>
        </tbody>
      </table>

      <table class="pgrid">
        <tbody>
          <tr><td class="lab">Туси / Colour</td><td class="val thin">{{ horse.color|dash }}</td></tr>
          <tr><td class="lab">ДНК №</td><td class="val thin">—</td></tr>
          <tr><td class="lab">ПИНК №</td><td class="val thin">—</td></tr>
          <tr><td class="lab">SNB №</td><td class="val thin">—</td></tr>
          <tr><td class="lab">Туғилган санаси / Date of birth</td><td class="val thin">{{ horse.birth_date|dmy|dash }}</td></tr>
        </tbody>
      </table>
    </div>

    <table class="pgrid" style="margin-top:4mm;">
      <tbody>
        <tr><td class="lab">Иммунитет экспертизаси рақами, санаси / Immunity expertise №, date</td><td class="val thin">—</td></tr>
      </tbody>
    </table>
  </div>

  <div class="sheet">
    <img src="{{ public_base_url }}{% static 'report/passport_17.png' %}" alt="">
  </div>

  <h3 class="title">
    Чипнинг идентификация рақами / Идентификационный номер чипа<br>
    <span class="muted">Chip identification number</span>
  </h3>

  <table class="chip-table">
    <colgroup><col class="c-date"><col class="c-chip"><col class="c-bar"></colgroup>
    <thead>
      <tr>
        <th><span class="tri">Сана</span><span class="tri">Дата</span><span class="tri"><strong>Date</strong></span></th>
        <th><span class="tri">Чип коди</span><span class="tri">Код чипа</span><span class="tri"><strong>Chip code</strong></span></th>
        <th><span class="tri">Штрих код</span><span class="tri">Barcode</span><span class="tri"><strong>Barcode</strong></span></th>
      </tr>
    </thead>
    <tbody>
      <!-- Первая строка — из БД -->
      <tr class="row-fill">
        <td class="lined">{{ passport.issue_date|dmy|dash }}</td>
        <td class="lined">{{ horse.microchip|dash }}</td>
        <td class="lined">
          {% if passport.barcode_image %}
            <img class="barcode" src="{{ passport.barcode_image|fileuri }}" alt="barcode">
            {% if passport.barcode_value %}<div style="margin-top:1mm">{{ passport.barcode_value }}</div>{% endif %}
          {% endif %}
        </td>
      </tr>

      <!-- Ещё строки для ручного внесения -->
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
      <tr class="row-fill"><td class="lined"></td><td class="lined"></td><td class="lined"></td></tr>
    </tbody>
  </table>

  <div class="signbox">
    Федерация раиси ўринбосари / Заместитель председателя Федерации / Deputy-chairman of Federation,
    <span class="line"></span>
  </div>
  <div class="signbox">
    Берилган вакти / Дата выдачи / <em>Date of issue</em>: <span class="line">{{ passport.issue_date|dmy|dash }}</span>
  </div>
{% endblock %}

