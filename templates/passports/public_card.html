{% extends 'layout/master.html' %}
{% load static %}
{% load pdf_utils %}

{% block title %}Информация о лошади{% endblock title %}
{% block extra_css %}

{% endblock %}
{% block layout %}

<div class="container flex-grow-1 container-p-y">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h4 class="mb-0">Паспорт № {{ p.number }}</h4>
    <div>
      {% if p.old_passport_number and p.qr_image %}
        <a class="btn btn-outline-primary" href="{{ p.qr_image.url }}" target="_blank" rel="noopener">
          QR (PNG)
        </a>
      {% endif %}
      {% if p.pdf_file %}
      <a class="btn btn-outline-secondary" href="{{ p.pdf_file.url }}" target="_blank">PDF</a>
      {% endif %}
    </div>
  </div>
  <div class="row g-4">
    <div class="col-12">
      <div class="card h-100 wm-host">
        <div class="card-body">

          {# ВОДЯНОЙ ЗНАК ТОЛЬКО ДЛЯ АННУЛИРОВАННЫХ #}
          {% if p.status == 'REVOKED' %}
            <div class="wm-revoked" style="">Аннулировано</div>
          {% endif %}

          <h6 class="text-muted">Данные лошади</h6>
          <hr>
          <div class="row mb-3">
            <div class="col-sm-6 mb-1"><strong>Кличка:</strong> {{ p.horse.name }}</div>
            <div class="col-sm-6 mb-1"><strong>Порода:</strong> {{ p.horse.breed.name }}</div>
            <div class="col-sm-6 mb-1"><strong>Масть:</strong> {{ p.horse.color.name }}</div>
            <div class="col-sm-6 mb-1"><strong>Дата рождения:</strong> {{ p.horse.birth_date|date:'d.m.Y' }}</div>
            <div class="col-sm-6 mb-1"><strong>Владелец:</strong> {{ p.horse.owner_current }}</div>
          </div>
          <div class="row">
            <div class="col-12">
              {# Одно фото лошади: показываем первое доступное #}
              {% if p.horse.photo_right_side %}
                <div class="text-center mb-4">
                  <img src="{{ p.horse.photo_right_side.url }}" alt="Фото лошади" style="max-width:300px; height:auto; border-radius:10px; object-fit: contain;">
                </div>
              {% elif p.horse.photo_left_side %}
                <div class="text-center mb-4">
                  <img src="{{ p.horse.photo_left_side.url }}" alt="Фото лошади" style="max-width:300px; height:auto; border-radius:10px; object-fit: contain;">
                </div>
              {% elif p.horse.photo_muzzle %}
                <div class="text-center mb-4">
                  <img src="{{ p.horse.photo_muzzle.url }}" alt="Фото лошади" style="max-width:300px; height:auto; border-radius:10px; object-fit: contain;">
                </div>
              {% elif p.horse.photo_upper_eye_level %}
                <div class="text-center mb-4">
                  <img src="{{ p.horse.photo_upper_eye_level.url }}" alt="Фото лошади" style="max-width:300px; height:auto; border-radius:10px; object-fit: contain;">
                </div>
              {% endif %}
            </div>
          </div>

          <h6 class="text-muted mt-5">Лабораторные исследования</h6>
          <div class="mb-4 table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Тип</th>
                  <th>Название/результат</th>
                  <th>Врач</th>
                </tr>
              </thead>
              <tbody>
                {# Показываем ЛАБОРАТОРНЫЕ ИССЛЕДОВАНИЯ #}
                {% for t in p.horse.lab_tests.all %}
                  <tr>
                    <td>{{ t.date|date:'d.m.Y' }}</td>
                    <td>{{ t.test_type.name }}</td>
                    <td>{{ t.result }}</td>
                    <td>{{ t.veterinarian }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-center">Нет данных</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {# Отдельная таблица: Вакцинация #}
          <h6 class="text-muted mt-5">Вакцинация</h6>
          <div class="mb-4 table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>Дата</th>
                  <th>Вакцина</th>
                  <th>Серия/партия</th>
                  <th>Врач</th>
                </tr>
              </thead>
              <tbody>
                {% for v in p.horse.vaccinations.all %}
                  <tr>
                    <td>{{ v.date|date:'d.m.Y' }}</td>
                    <td>{{ v.vaccine.name }}</td>
                    <td>{{ v.batch_no|default:"—" }}</td>
                    <td>{{ v.veterinarian }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-center">Нет данных</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card-footer text-center">
            <h5>Номер микрочипа</h5>
            {% if p.barcode_image %}
              <img src="{{ p.barcode_image.url }}" class="mb-3" style="max-width:260px;" alt="BAR"/>
            {% endif %}
            <div class="text-muted">
              Статус: {{ p.get_status_display }}{% if p.issue_date %} от {{ p.issue_date|date:'d.m.Y' }}{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

